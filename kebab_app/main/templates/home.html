{% extends 'base.html' %}

{% block title %}Головна - Kebab Spots{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        #map {
            height: 400px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row justify-content-center mb-3">
            <div class="col-12 text-center">
                <form action="{% url 'main:search' %}" method="get" class="form-inline justify-content-center mb-3">
                    <input type="text" id="searchQuery" name="q" class="form-control mr-sm-2"
                           placeholder="Введіть назву населеного пункту">
                    <button type="submit" class="btn btn-primary">Пошук</button>
                </form>
                <a href="{% url 'main:create_kebab_spot' %}" class="btn btn-primary">Додати точку для шашлику</a>
            </div>
        </div>
        <div class="row justify-content-left">
            <div class="col-lg-8 col-md-10 col-sm-12">
                <div id="map"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
                var map = initMap('map');
                initMapWithUserLocation(map, "{% url 'main:home' %}");

                var kebabSpots = {{ kebab_spots_json|safe }};
                console.log('Kebab spots data:', kebabSpots);
                addKebabSpots(map, kebabSpots);

                function initMap(elementId, initialView = [0, 0], zoom = 2) {
                    var map = L.map(elementId).setView(initialView, zoom);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    return map;
                }

                function addKebabSpots(map, spots) {
                    spots.forEach(function (spot) {
                        if (spot.lat && spot.lng && !isNaN(spot.lat) && !isNaN(spot.lng)) {
                            var latlng = [parseFloat(spot.lat), parseFloat(spot.lng)];
                            var marker = L.marker(latlng).addTo(map);

                            var tooltipContent = spot.name + '<br>Рейтинг: ' + (spot.avg_rating ? spot.avg_rating.toFixed(1) : 'Немає оцінок');
                            marker.bindTooltip(tooltipContent, {
                                permanent: false,
                                direction: 'top',
                                offset: L.point(-14, -13)  // Зміщення tooltip вгору
                            });

                            marker.on('click', function () {
                                window.location.href = spot.url;
                            });
                        } else {
                            console.warn('Invalid coordinates for spot:', spot);
                        }
                    });
                }

                function initMapWithUserLocation(map, url, callback) {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;
                            map.setView([lat, lng], 13);

                            // Створюємо червону іконку для маркера
                            var redIcon = new L.Icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            });

                            // Додаємо червоний маркер "Ви тут"
                            L.marker([lat, lng], {icon: redIcon}).addTo(map)
                                .bindPopup('Ви тут')
                                .openPopup();

                            fetchKebabSpots(url, lat, lng, function (spots) {
                                addKebabSpots(map, spots);
                                if (callback) callback(map, lat, lng);
                            });
                        }, function (error) {
                            console.error("Geolocation error: ", error);
                        });
                    } else {
                        console.error("Geolocation is not available");
                    }
                }

                function fetchKebabSpots(url, lat, lng, callback) {
                    fetch(`${url}?lat=${lat}&lng=${lng}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Fetched kebab spots:', data);  // Для відлагодження
                            callback(data);
                        })
                        .catch(error => {
                            console.error('Error fetching kebab spots:', error);
                        });
                }
            }
        )
        ;
    </script>
{% endblock %}
